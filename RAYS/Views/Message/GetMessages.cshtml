@model RAYS.ViewModels.MessageViewModel

@{
    ViewData["Title"] = "Messages";
    var receiverUsername = Model.ReceiverName;
    var currentUserId = Model.CurrentUserId;
    var senderId = Model.SenderId;
    var receiverId = Model.ReceiverId;
    var messages = Model.Messages;

    // Definer norsk tidssone
    var norwegianTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Central European Standard Time");
}

<div class="flex flex-col h-[90vh] bg-white shadow-2xl rounded-lg p-6">
    <!-- Header med tilbake-knapp og mottakerens brukernavn -->
    <div class="flex items-center justify-between bg-emerald-200 p-4 rounded-md mb-4">
        <button 
            onclick="window.location.href='@Url.Action("GetConversations", "Message")'"
            class="text-black text-2xl font-semibold">
            ←
        </button>
        <h2 class="text-xl font-extrabold font-general text-black ml-auto">
            @receiverUsername
        </h2>
    </div>

    <!-- Meldingsområde -->
    <div id="messageContainer" class="flex-grow space-y-4 overflow-y-auto bg-white rounded-lg p-4">
        @if (messages != null && messages.Any())
        {
            @foreach (var message in messages)
            {
                <div class="flex @(message.SenderId == currentUserId ? "justify-end" : "justify-start")">
                    <div class="max-w-[60%] px-4 py-2 rounded-lg shadow-md text-sm font-medium
                                 @(message.SenderId == currentUserId ? "bg-blue-500 text-white rounded-tl-2xl rounded-br-2xl" : "bg-gray-300 text-black rounded-tr-2xl rounded-bl-2xl")"
                         style="word-break: break-word; overflow-wrap: break-word;">
                        <p class="mb-1">@message.Content</p>
                        <p class="text-xs"
                           style="color: @(message.SenderId == currentUserId ? "white" : "black");">
                            @TimeZoneInfo.ConvertTimeFromUtc(message.Timestamp, norwegianTimeZone).ToString("g")
                        </p>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-gray-400 text-center">No messages yet</div>
        }
        <div id="scrollToBottom"></div>
    </div>

    <!-- Input-område for å sende nye meldinger -->
    <form method="post" action="@Url.Action("SendMessage", "Message")" class="mt-4 flex items-center bg-emerald-200 border p-4 rounded-md">
        <input type="hidden" name="receiverId" value="@receiverId" />
        <input 
            type="text" 
            name="newMessage" 
            placeholder="Type a message..."
            class="flex-grow p-2 border-gray-300 border-2 rounded bg-white text-black focus:outline-none focus:ring-2 focus:ring-emerald-500" />
        <button 
            type="submit" 
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-500 transition duration-200">
            Send
        </button>
    </form>
</div>

<!-- JavaScript for automatisk scroll til bunn -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function scrollToBottom() {
            var messageContainer = document.getElementById('messageContainer');
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        scrollToBottom();

        const observer = new MutationObserver(scrollToBottom);
        observer.observe(document.getElementById('messageContainer'), { childList: true, subtree: true });
    });
</script>

